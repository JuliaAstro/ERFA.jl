using BinaryProvider

# This is where all binaries will get installed
const prefix = Prefix(!isempty(ARGS) ? ARGS[1] : joinpath(@__DIR__,"usr"))

liberfa = LibraryProduct(prefix, "liberfa")

products = [liberfa]

# Download binaries from hosted location
bin_prefix = "https://github.com/JuliaAstro/ERFABuilder/releases/download/v1.4.0"

# Listing of files generated by BinaryBuilder:
download_info = Dict(
    BinaryProvider.Linux(:aarch64, :glibc) => ("$bin_prefix/liberfa.aarch64-linux-gnu.tar.gz", "04e2f48454d7922461b4316794c7b081bea21520b6e70e1ba95b68af02fa7f9b"),
    BinaryProvider.Linux(:armv7l, :glibc) => ("$bin_prefix/liberfa.arm-linux-gnueabihf.tar.gz", "2054173cf2ce4e8f410b93475103b68e5d007052c4b1f24cb5a6bfcad3f94415"),
    BinaryProvider.Linux(:i686, :glibc) => ("$bin_prefix/liberfa.i686-linux-gnu.tar.gz", "b0bfb34e57d5f1cc1a4c7893a324f93692e8c68c9615bc2758926c69013eba6d"),
    BinaryProvider.Windows(:i686) => ("$bin_prefix/liberfa.i686-w64-mingw32.tar.gz", "05b56c195eeef9ca9ed04ec8f22a2920c62cd2e7ef23c23b42146525cdc412cd"),
    BinaryProvider.Linux(:powerpc64le, :glibc) => ("$bin_prefix/liberfa.powerpc64le-linux-gnu.tar.gz", "1c97aa9f23eb02ffa0cabde95bb8b6b0107c5a620b122a8c47be9c209ec72cd8"),
    BinaryProvider.MacOS() => ("$bin_prefix/liberfa.x86_64-apple-darwin14.tar.gz", "e82fc8bcfe68e96e7f6b29a0e78c3adec67b5cbc824623b41286e55916a68c64"),
    BinaryProvider.Linux(:x86_64, :glibc) => ("$bin_prefix/liberfa.x86_64-linux-gnu.tar.gz", "b72c910a704f574724c62e356ffb751176f87211bd65a9dc51f5fd57b660c161"),
    BinaryProvider.Windows(:x86_64) => ("$bin_prefix/liberfa.x86_64-w64-mingw32.tar.gz", "b900167663c0fbd0b97f46b011b02b53e95871a8f9d6ba261eeb790aed1da79d"),
)

if platform_key() in keys(download_info)
    # First, check to see if we're all satisfied
    if any(!satisfied(p; verbose=true) for p in products)
        # Download and install binaries
        url, tarball_hash = download_info[platform_key()]
        install(url, tarball_hash; prefix=prefix, force=true, verbose=true)
    end
    # Finally, write out a deps.jl file that will contain mappings for each
    # named product here: (there will be a "libfoo" variable and a "fooifier"
    # variable, etc...)
    @write_deps_file liberfa
else
    error("Your platform $(Sys.MACHINE) is not supported by this package!")
end